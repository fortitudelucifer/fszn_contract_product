{% extends 'base.html' %}

{% block title %}文件管理 - {{ contract.project_code }}{% endblock %}

{% block content %}
<h1>文件管理</h1>

<p>
    <strong>项目编号：</strong>{{ contract.project_code }}<br>
    <strong>合同名称：</strong>{{ contract.name }}<br>
    <strong>客户公司：</strong>{{ contract.company.name if contract.company else '' }}
</p>

<!-- 顶部导航 -->
<p>
    <a href="{{ url_for('contracts.list_contracts') }}">返回项目列表</a> |
    <a href="{{ url_for('contracts.manage_sales', contract_id=contract.id) }}">销售信息</a> |
    <a href="{{ url_for('contracts.manage_leaders', contract_id=contract.id) }}">部门负责人</a> |
    <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}">任务/进度</a> |
    <a href="{{ url_for('contracts.manage_procurements', contract_id=contract.id) }}">采购清单</a> |
    <a href="{{ url_for('contracts.manage_acceptances', contract_id=contract.id) }}">验收</a> |
    <a href="{{ url_for('contracts.manage_feedbacks', contract_id=contract.id) }}">客户反馈</a> |
    <a href="{{ url_for('contracts.manage_files', contract_id=contract.id) }}">文件</a>
</p>

<!-- 操作风险提示 -->
<div style="border:1px solid #f99; padding:8px; margin-bottom:10px;">
    <strong>操作风险提示：</strong><br>
    1. 删除文件后，普通用户将无法再访问该文件，如需恢复只能由管理员在数据库中手工操作，请谨慎删除。<br>
    2. 上传前请确认文件内容和类型是否正确，避免将错误文件共享给客户或其他部门。<br>
    3. 大文件会占用较多存储资源，请尽量压缩或拆分上传。<br>
</div>

<h2>当前文件</h2>

<form method="get" style="margin-bottom: 10px; border:1px solid #ccc; padding:8px;">
    <strong>筛选条件：</strong>
    <label style="margin-right: 10px;">
        文件类型：
        <select name="file_type">
            <option value="" {% if not filter_file_type %}selected{% endif %}>全部</option>
            <option value="contract" {% if filter_file_type=='contract' %}selected{% endif %}>合同</option>
            <option value="tech" {% if filter_file_type=='tech' %}selected{% endif %}>技术文档</option>
            <option value="drawing" {% if filter_file_type=='drawing' %}selected{% endif %}>图纸</option>
            <option value="invoice" {% if filter_file_type=='invoice' %}selected{% endif %}>其它</option>
        </select>
    </label>

    <label style="margin-right: 10px;">
        公开状态：
        <select name="is_public">
            <option value="" {% if not filter_is_public %}selected{% endif %}>全部</option>
            <option value="1" {% if filter_is_public=='1' %}selected{% endif %}>只看公开</option>
            <option value="0" {% if filter_is_public=='0' %}selected{% endif %}>只看未公开</option>
        </select>
    </label>

    {% if user and user.role in ['admin', 'boss'] %}
    <label style="margin-right: 10px;">
        <input type="checkbox" name="show_deleted" value="1"
               {% if filter_show_deleted %}checked{% endif %}>
        显示已删除文件
    </label>
    {% endif %}

    <label style="margin-right: 10px;">
        <input type="checkbox" name="latest_only" value="1"
               {% if filter_latest_only %}checked{% endif %}>
        只看最新版本
    </label>

    <button type="submit">筛选</button>
</form>

  {% if files %}
<table border="1" cellpadding="4" cellspacing="0">
    <thead>
        <tr>
            <th>ID</th>
            <th>文件名（生成）</th>
            <th>原始文件名</th>
            <th>类型</th>
            <th>版本</th>
            <th>作者</th>
            <!--<th>上传者</th>-->
            <th>大小</th>
            <th>是否公开</th>
            <th>上传时间</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for f in files %}
        <tr>
            <td>{{ f.id }}</td>
            <td>{{ f.stored_filename }}</td>
            <td>{{ f.original_filename }}</td>
            <td>
                {% if f.file_type == 'contract' %}合同
                {% elif f.file_type == 'tech' %}技术文档
                {% elif f.file_type == 'drawing' %}图纸
                {% else %}其它{% endif %}
            </td>
            <td>
                {{ f.version }}
                {% if latest_ids and f.id in latest_ids %}
                <span style="color: green; font-size: 12px;">（最新）</span>
                {% endif %}
            </td>
            <td>{{ f.author }}</td>
            <!--<td>{{ f.uploader.username if f.uploader else '' }}</td>-->
            <td>{{ human_filesize(f.file_size) }}</td>

            <td>{{ '是' if f.is_public else '否' }}</td>
            <td>
                {{ f.created_at.strftime('%Y-%m-%d %H:%M:%S') if f.created_at else '' }}
            </td>

            <td>
                <a href="{{ url_for('contracts.preview_file', contract_id=contract.id, file_id=f.id) }}" target="_blank">预览</a>
                |
                <a href="{{ url_for('contracts.download_file', contract_id=contract.id, file_id=f.id) }}">下载</a>
                |
                <form method="post"
                      action="{{ url_for('contracts.delete_file', contract_id=contract.id, file_id=f.id) }}"
                      style="display:inline;">
                    <button type="submit"
                            onclick="return confirm('确认删除该文件？删除后普通用户将无法恢复。');">
                        删除
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
  {% else %}
<p>当前该项目还没有文件。</p>
  {% endif %}

<h2>上传新文件</h2>

<!-- 上传提示：命名规则 & 大小限制 -->
<div style="border:1px solid #99c; padding:8px; margin-bottom:10px;">
    <strong>命名与上传提示：</strong><br>
    1. 系统会自动根据以下规则生成文件名：<br>
    <code>客户公司_项目编号_合同编号_合同名称_上传日期_文件类型_文件原始名_版本号_作者.扩展名</code><br>
    2. 你只需要选择文件、选择文件类型、填写版本号（可选），作者将自动使用当前登录用户名。<br>
    3. 建议尽量上传 PDF 或常见图片格式（PNG/JPG），单个文件大小不超过 {{ (config.MAX_CONTENT_LENGTH or 0) // (1024*1024) }} MB，但也支持其它类型文件。<br>
</div>

<style>
    .upload-box {
        border: 2px dashed #bbb;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: 0.2s;
    }

        .upload-box.dragover {
            background: #eef7ff;
            border-color: #3399ff;
        }

    .file-list {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #ddd;
        margin-top: 10px;
        padding: 6px;
        border-radius: 6px;
        font-size: 13px;
        background: #fff;
    }

    .file-list-item {
        border-bottom: 1px solid #eee;
        padding: 3px 0;
    }
</style>

<form method="post" enctype="multipart/form-data" id="uploadForm">

    <!-- ⬇ 上传盒子（可点击+可拖拽） -->
    <div id="uploadBox" class="upload-box">
        <div id="uploadText">点击或拖拽文件到此处（可多选）</div>
        <input type="file" id="fileInput" name="files" multiple style="display: none;">
    </div>

    <!-- ⬇ 已选择文件预览 -->
    <div id="fileList" class="file-list" style="display: none;"></div>

    <p>
        <label>
            文件类型：
            <select name="file_type" required>
                <option value="contract">合同</option>
                <option value="tech">技术文档</option>
                <option value="drawing">图纸</option>
                <option value="invoice">其它</option>
            </select>
        </label>
    </p>

    <p>
        <label>
            版本：
            <input type="text" name="version" placeholder="如：V1，1.0，1.1，2.0等" required>
        </label>
    </p>

    <p>
        <label>
            <input type="checkbox" name="is_public" value="1">
            对客户公开
        </label>
    </p>

    <button type="submit">上传</button>
</form>

<script>
    const uploadBox = document.getElementById("uploadBox");
    const fileInput = document.getElementById("fileInput");
    const fileListDiv = document.getElementById("fileList");
    const uploadText = document.getElementById("uploadText");

    uploadBox.onclick = () => fileInput.click();

    uploadBox.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadBox.classList.add("dragover");
    });

    uploadBox.addEventListener("dragleave", () => {
        uploadBox.classList.remove("dragover");
    });

    uploadBox.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadBox.classList.remove("dragover");

        fileInput.files = e.dataTransfer.files;
        updateFileList();
    });

    fileInput.onchange = updateFileList;

    function updateFileList() {
        const files = fileInput.files;
        if (!files.length) {
            fileListDiv.style.display = "none";
            uploadText.innerText = "点击或拖拽文件到此处（可多选）";
            return;
        }

        uploadText.innerText = `已选择 ${files.length} 个文件`;

        let html = "";
        for (let f of files) {
            html += `<div class="file-list-item">${f.name}</div>`;
        }
        fileListDiv.innerHTML = html;
        fileListDiv.style.display = "block";
    }
</script>

{% endblock %}
