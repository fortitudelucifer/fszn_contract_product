{% extends 'base.html' %}

{% block title %}文件管理 - {{ contract.project_code }}{% endblock %}

{% block content %}
<h1>文件管理（上传新文件往最下方滑动）</h1>

<div style="font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #333;">
    <span>客户公司：{{ contract.company.name if contract.company else '' }}</span>
    <span style="margin: 0 10px;"></span><br>
    <span>项目编号：{{ contract.project_code }}</span>
    <span style="margin: 0 10px;"></span><br>
    <span>合同内容/名称：{{ contract.name }}</span>
</div>

<!-- 顶部导航 -->
<p>
    <a href="{{ url_for('contracts.list_contracts') }}">返回项目列表</a> |
    <a href="{{ url_for('contracts.manage_sales', contract_id=contract.id) }}">销售信息</a> |
    <a href="{{ url_for('contracts.manage_leaders', contract_id=contract.id) }}">部门负责人</a> |
    <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}">任务/进度</a> |
    <a href="{{ url_for('contracts.manage_procurements', contract_id=contract.id) }}">采购清单</a> |
    <a href="{{ url_for('contracts.manage_acceptances', contract_id=contract.id) }}">验收</a> |
    <a href="{{ url_for('contracts.manage_feedbacks', contract_id=contract.id) }}">客户反馈</a> |
    <a href="{{ url_for('contracts.manage_files', contract_id=contract.id) }}">文件</a>
</p>

<!-- 操作风险提示 -->
<div style="border:1px solid #f99; padding:8px; margin-bottom:10px;">
    <strong>操作风险提示：</strong><br>
    1. 删除文件后，普通用户将无法再访问该文件，如需恢复只能由管理员在数据库中手工操作，请谨慎删除。<br>
    2. 上传前请确认文件内容和类型是否正确，避免将错误文件共享给客户或其他部门。<br>
    3. 大文件会占用较多存储资源，请尽量压缩或拆分上传。<br>
</div>

<h2>当前文件</h2>

<form method="get" style="margin-bottom: 10px; border:1px solid #ccc; padding:8px;">
    <strong>筛选条件(非上传，是筛选功能)：</strong>
    <label style="margin-right: 10px;">
        文件类型：
        <select name="file_type">
            <option value="" {% if not filter_file_type %}selected{% endif %}>全部</option>
            <option value="contract" {% if filter_file_type=='contract' %}selected{% endif %}>合同</option>
            <option value="tech" {% if filter_file_type=='tech' %}selected{% endif %}>技术文档</option>
            <option value="drawing" {% if filter_file_type=='drawing' %}selected{% endif %}>图纸</option>
            <option value="invoice" {% if filter_file_type=='invoice' %}selected{% endif %}>其它</option>
        </select>
    </label>

    <label style="margin-right: 10px;">
        公开状态：
        <select name="is_public">
            <option value="" {% if not filter_is_public %}selected{% endif %}>全部</option>
            <option value="1" {% if filter_is_public=='1' %}selected{% endif %}>只看公开</option>
            <option value="0" {% if filter_is_public=='0' %}selected{% endif %}>只看未公开</option>
        </select>
    </label>

    {% if user and user.role in ['admin', 'boss'] %}
    <label style="margin-right: 10px;">
        <input type="checkbox" name="show_deleted" value="1"
               {% if filter_show_deleted %}checked{% endif %}>
        显示已删除文件
    </label>
    {% endif %}

    <label style="margin-right: 10px;">
        <input type="checkbox" name="latest_only" value="1"
               {% if filter_latest_only %}checked{% endif %}>
        只看最新版本
    </label>

    <button type="submit">筛选</button>
</form>

  {% if files %}
<table border="1" cellpadding="4" cellspacing="0">
    <thead>
        <tr>
            <th>文件名（生成）</th>
            <th>原始文件名</th>
            <th>类型</th>
            <th>版本</th>
            <th>作者</th>
            <!--<th>上传者</th>-->
            <th>大小</th>
            <th>是否公开</th>
            <th>上传时间</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for f in files %}
        <tr>
            <td>{{ f.stored_filename }}</td>
            <td>{{ f.original_filename }}</td>
            <td>
                {% if f.file_type == 'contract' %}合同
                {% elif f.file_type == 'tech' %}技术文档
                {% elif f.file_type == 'drawing' %}图纸
                {% else %}其它{% endif %}
            </td>
            <td>
                {{ f.version }}
                {% if latest_ids and f.id in latest_ids %}
                <span style="color: green; font-size: 12px;">（最新）</span>
                {% endif %}
            </td>
            <td>{{ f.author }}</td>
            <!--<td>{{ f.uploader.username if f.uploader else '' }}</td>-->
            <td>{{ human_filesize(f.file_size) }}</td>

            <td>{{ '是' if f.is_public else '否' }}</td>
            <td>
                {{ f.created_at.strftime('%Y-%m-%d %H:%M:%S') if f.created_at else '' }}
            </td>

            <td>
                <a href="{{ url_for('contracts.preview_file', contract_id=contract.id, file_id=f.id) }}" target="_blank">预览</a>
                |
                <a href="{{ url_for('contracts.download_file', contract_id=contract.id, file_id=f.id) }}">下载</a>
                |
                <form method="post"
                      action="{{ url_for('contracts.delete_file', contract_id=contract.id, file_id=f.id) }}"
                      style="display:inline;">
                    <button type="submit"
                            onclick="return confirm('确认删除该文件？删除后普通用户将无法恢复。');">
                        删除
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
  {% else %}
<p>当前该项目还没有文件。</p>
  {% endif %}

<h2 style="font-size: 22px; font-weight: bold; margin-top: 30px; margin-bottom: 15px;">
    上传新文件（在下方虚线上传栏点击或拖拽上传，多个文件时先在键盘上按住 ctrl 鼠标单击多选文件再上传即可上传多个文件）
</h2>

<div style="border:1px solid #99c; padding:15px; margin-bottom:20px; background-color: #fcfcfc;">
    <strong>命名与上传提示：</strong><br>
    <div style="margin-top: 8px;">
        1. 系统会自动根据以下规则<span style="color: red; font-weight: bold;">生成文件名</span>：<br>
        <div style="font-size: 18px; font-weight: 900; margin: 10px 0; color: #000; background-color: #eef; padding: 8px; border-radius: 4px;">
            客户公司_项目编号_合同编号_合同名称_上传日期_文件类型_文件原始名_版本号_作者.扩展名
        </div>
    </div>
    2. 你只需要选择文件、选择文件类型、填写版本号（可选），作者将自动使用当前登录用户名。<br>
    3. 建议尽量上传 PDF 或常见图片格式（PNG/JPG），单个文件大小不超过 {{ (config.MAX_CONTENT_LENGTH or 0) // (1024*1024) }} MB，但也支持其它类型文件。<br>
</div>

<style>
    /* 上传盒子样式优化 */
    .upload-box {
        /* 1. 差异度：使用明显的蓝色虚线边框和淡蓝背景，与周围白色背景区分 */
        border: 3px dashed #4a90e2;
        background: #f0f8ff;
        /* 2. 显示大小：大幅增加内边距，让盒子变高变大，方便拖拽 */
        padding: 60px 20px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* 加一点阴影增加立体感 */
    }

        /* 悬停或拖拽文件进入时的效果 */
        .upload-box:hover,
        .upload-box.dragover {
            background: #e1f0ff;
            border-color: #0056b3;
            transform: scale(1.01); /* 轻微放大，增加交互感 */
        }

    /* 盒子内的文字样式 */
    #uploadText {
        font-size: 24px; /* 文字加大 */
        font-weight: 900; /* 文字加粗 */
        color: #2c5282; /* 深蓝色文字 */
    }

    /* 下方的小字提示样式（可选） */
    .upload-subtext {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }

    /* 文件列表样式（保持原样微调） */
    .file-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        margin-top: 10px;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        background: #fff;
    }

    .file-list-item {
        border-bottom: 1px solid #eee;
        padding: 6px 0;
        color: #333;
    }
</style>

<form method="post" enctype="multipart/form-data" id="uploadForm">

    <div id="uploadBox" class="upload-box">
        <div id="uploadText">点击此处 或 拖拽文件到这里</div>
        <div class="upload-subtext">支持多选，可一次上传多个文件</div>

        <input type="file" id="fileInput" name="files" multiple style="display: none;">
    </div>

    <!-- ⬇ 已选择文件预览 -->
    <div id="fileList" class="file-list" style="display: none;"></div>

    <p>
        <label>
            文件类型：
            <select name="file_type" required>
                <option value="contract">合同</option>
                <option value="tech">技术文档</option>
                <option value="drawing">图纸</option>
                <option value="invoice">其它</option>
            </select>
        </label>
    </p>

    <p>
        <label>
            版本：
            <input type="text" name="version" placeholder="如：1.0，1.1，2.0，盖章版，未盖章版等" required>
        </label>
    </p>

    <p>
        <label>
            <input type="checkbox" name="is_public" value="1">
            对客户公开
        </label>
    </p>

    <button type="submit">上传</button>
</form>

<script>
    const uploadBox = document.getElementById("uploadBox");
    const fileInput = document.getElementById("fileInput");
    const fileListDiv = document.getElementById("fileList");
    const uploadText = document.getElementById("uploadText");

    uploadBox.onclick = () => fileInput.click();

    uploadBox.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadBox.classList.add("dragover");
    });

    uploadBox.addEventListener("dragleave", () => {
        uploadBox.classList.remove("dragover");
    });

    uploadBox.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadBox.classList.remove("dragover");

        fileInput.files = e.dataTransfer.files;
        updateFileList();
    });

    fileInput.onchange = updateFileList;

    function updateFileList() {
        const files = fileInput.files;
        if (!files.length) {
            fileListDiv.style.display = "none";
            uploadText.innerText = "点击或拖拽文件到此处（可多选）";
            return;
        }

        uploadText.innerText = `已选择 ${files.length} 个文件`;

        let html = "";
        for (let f of files) {
            html += `<div class="file-list-item">${f.name}</div>`;
        }
        fileListDiv.innerHTML = html;
        fileListDiv.style.display = "block";
    }
</script>

{% endblock %}
