{% extends 'base.html' %}

{% block content %}
<h2>发送通知：{{ contract.project_code }} - {{ contract.name }}</h2>

<p>客户公司：{{ contract.company.name if contract.company else '' }}</p>

<form method="post" action="{{ url_for('contracts.notify_contract', contract_id=contract.id) }}">
    <div style="margin-bottom: 8px;">
        <label>事件类型：</label>
        <select name="event_code">
            {% for code, label in notification_event_choices %}
                <option value="{{ code }}" {% if code == default_event_code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <div style="font-size: 12px; color: #666;">
            用于标记本次通知属于哪类事件，便于后期在操作日志中筛选。
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label>通知通道：</label>
        <select name="channel">
            <!-- 钉钉群机器人 -->
            <option value="ding" {% if default_channel == 'ding' %}selected{% endif %}>钉钉</option>

            <!-- 企业微信/微信群机器人（走 wechat 通道） -->
            <option value="wechat" {% if default_channel == 'wechat' %}selected{% endif %}>企业微信 / 微信</option>

            <!-- 手机短信（走 sms 通道） -->
            <option value="sms" {% if default_channel == 'sms' %}selected{% endif %}>手机</option>

            <!-- 邮件（走 email 通道） -->
            <option value="email" {% if default_channel == 'email' %}selected{% endif %}>邮件</option>
        </select>

        <div style="font-size: 12px; color: #666;">
            根据这里选择的通道，系统会在你选择了“接收用户”且未手动填写“接收人”时，
            自动使用对应的联系方式（邮箱 / 手机 / 微信等）。
        </div>
    </div>


    <div style="margin-bottom: 8px;">
        <label>接收用户（系统内已注册，可选）：</label><br>
        <select name="target_user_id" style="width: 100%;">
            <option value="">-- 选择一个已注册用户（可选） --</option>
            {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }}（邮箱：{{ u.email }}，手机：{{ u.phone }}, 微信：{{ u.wechat }}）</option>
            {% endfor %}
        </select>
        <div style="font-size: 12px; color: #666;">
            如选择了接收用户且未单独填写下方“接收人”，系统会根据上方选择的通知通道自动取对应联系方式。
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label>接收人（邮箱 / 手机 / 微信ID）：</label><br>
        <input type="text" name="target" value="{{ default_target or '' }}" style="width: 100%;">
        <div style="font-size: 12px; color: #666;">
            可用于给外部联系人发送通知，或覆盖上方自动选择的联系方式。
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label>模板编码：</label><br>
        <input type="text" name="template_code"
               value="{{ default_template_code or 'CONTRACT_EVENT' }}" style="width: 100%;">
        <div style="font-size: 12px; color: #666;">
            可约定一些常用编码，例如：<br>
            CONTRACT_DELAY（项目延期提醒）、CONTRACT_ACCEPTANCE（验收提醒）等。
        </div>
    </div>

    <div style="margin-bottom: 8px;">
        <label>通知内容：</label><br>
        <textarea name="message" rows="4" style="width: 100%;">{{ default_message or '' }}</textarea>
    </div>

    <div style="margin-top: 12px;">
        <button type="submit">发送</button>
        <a href="{{ url_for('contracts.list_contracts') }}" style="margin-left: 8px;">返回列表</a>
    </div>
</form>
{% endblock %}
