{% extends 'base.html' %}

{% block title %}任务与进度 - {{ contract.project_code }}{% endblock %}

{% block content %}
<h1>任务与生产进度</h1>

{{ super() }}

<p>
    <strong>项目编号：</strong>{{ contract.project_code }}<br>
    <strong>合同名称：</strong>{{ contract.name }}
</p>

<!-- 导航 -->
<p>
    <a href="{{ url_for('contracts.list_contracts') }}">返回项目列表</a> |
    <a href="{{ url_for('contracts.manage_leaders', contract_id=contract.id) }}">部门负责人</a> |
    <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}">任务/进度</a> |
    <a href="{{ url_for('contracts.manage_procurements', contract_id=contract.id) }}">采购清单</a> |
    <a href="{{ url_for('contracts.manage_acceptances', contract_id=contract.id) }}">验收</a> |
    <a href="{{ url_for('contracts.manage_feedbacks', contract_id=contract.id) }}">客户反馈</a> |
    <a href="{{ url_for('contracts.manage_files', contract_id=contract.id) }}">文件</a> |
    <a href="{{ url_for('contracts.tasks_by_department') }}" target="_blank">任务总览（按部门）</a> |
    <a href="{{ url_for('contracts.tasks_by_person') }}" target="_blank">任务总览（按人员）</a>
</p>


<h2>现有任务</h2>
  {% if tasks %}
<table border="1" cellpadding="4" cellspacing="0">
    <thead>
        <tr>
            <th>ID</th>
            <th>部门</th>
            <th>负责人</th>
            <th>任务名称</th>
            <th>开始日期</th>
            <th>完成日期</th>
            <th>状态</th>
            <th>备注</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tasks %}
        <tr>
            <td>{{ t.id }}</td>
            <td>{{ t.department.name if t.department else '' }}</td>
            <td>{{ t.person.name if t.person else '' }}</td>
            <td>{{ t.title }}</td>
            <td>{{ t.start_date }}</td>
            <td>{{ t.end_date or '' }}</td>
            <td>{{ t.status }}</td>
            <td>{{ t.remarks }}</td>
            <td>
                <!-- 状态操作按钮：开始 / 待质检 / 完成 / 暂停 -->
                <form method="post"
                      action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}"
                      style="display:inline;">
                    <input type="hidden" name="action" value="start">
                    <button type="submit">开始</button>
                </form>

                <form method="post"
                      action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}"
                      style="display:inline;">
                    <input type="hidden" name="action" value="wait_qc">
                    <button type="submit">待质检</button>
                </form>

                <form method="post"
                      action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}"
                      style="display:inline;">
                    <input type="hidden" name="action" value="complete">
                    <button type="submit">完成</button>
                </form>

                <form method="post"
                      action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}"
                      style="display:inline;">
                    <input type="hidden" name="action" value="pause">
                    <button type="submit">暂停</button>
                </form>

                <!-- 删除任务 -->
                <form method="post"
                      action="{{ url_for('contracts.delete_task', contract_id=contract.id, task_id=t.id) }}"
                      style="display:inline;">
                    <button type="submit" onclick="return confirm('确认删除该任务？');">删除</button>
                </form>
            </td>

        </tr>
        {% endfor %}
    </tbody>
</table>
  {% else %}
<p>当前还没有任务。</p>
  {% endif %}

<h2>新增任务</h2>
<form method="post">
    <p>
        <label>
            部门：
            <select name="department_id">
                <option value="">请选择部门</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.name }} (ID={{ d.id }})</option>
                {% endfor %}
            </select>
        </label>
    </p>
    <p>
        <label>
            负责人（可选）：
            <select name="person_id">
                <option value="">可不选</option>
                {% for p in persons %}
                <option value="{{ p.id }}">{{ p.name }} - {{ p.position }} (ID={{ p.id }})</option>
                {% endfor %}
            </select>
        </label>
    </p>
    <p>
        <label>
            任务名称：
            <input type="text" name="title">
        </label>
    </p>
    <p>
        <label>
            开始日期：
            <input type="date" name="start_date">
        </label>
    </p>
    <p>
        <label>
            完成日期（可选）：
            <input type="date" name="end_date">
        </label>
    </p>
    <p>
        <label>
            状态：
            新增任务时默认状态为“未开始”，请在上方任务列表中通过按钮修改状态。
        </label>
    </p>
    <p>
        <label>
            备注/需求：
            <textarea name="remarks" rows="3" cols="50"></textarea>
        </label>
    </p>
    <p>
        <button type="submit">保存任务</button>
    </p>
</form>
{% endblock %}
